{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Atualizar Caixa | Grupo GC</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="{% static 'extrato_app/css/conta_virtual.css' %}" />

  <style>
    /* === Estilos APENAS do modal. A lista usa o conta_virtual.css. === */
    .modal-backdrop {
      display:none; position: fixed; inset:0; background: rgba(0,0,0,.5);
      align-items: center; justify-content: center; padding: 16px; z-index: 9999;
    }
    .modal-backdrop.open { display:flex; }
    .modal {
      width: 100%; max-width: 820px; background: #fff; color:#222; border-radius: 16px; overflow:hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,.18);
      animation: modalIn .16s ease-out;
    }
    @keyframes modalIn { from{ transform: translateY(12px); opacity:0 } to{ transform: translateY(0); opacity:1 } }
    .modal-header {
      padding: 16px 18px; background: #f6f7fb; display:flex; align-items:center; justify-content:space-between;
      border-bottom: 1px solid #e6e7ee;
    }
    .modal-title { font-size: 1.1rem; font-weight: 700; display:flex; align-items:center; gap:8px; }
    .modal-body { padding: 16px 18px; max-height: 70vh; overflow:auto; }
    .modal-footer { padding: 14px 18px; display:flex; gap:10px; justify-content:flex-end; border-top:1px solid #e6e7ee; background:#fafbfe; }
    .close-btn { background: transparent; border:none; font-size: 1.4rem; cursor:pointer; color:#444; }
    .field-row {
      display:grid; grid-template-columns: 1fr 180px 180px; gap:12px; align-items:center;
      border:1px solid #e7e9f1; border-radius:12px; padding:10px 12px; background:#fff; margin-bottom:10px;
    }
    .modal-section-title { font-weight:700; margin-bottom:10px; display:flex; align-items:center; gap:6px; }
    .input-text, .form-select { width: 100%; }
    .btn-secondary {
      background: #eef1f6; border:1px solid #d7dce5; padding:10px 14px; border-radius:10px; cursor:pointer;
    }
    .info-badge { margin-top:6px; display:flex; align-items:center; gap:6px; font-size:.9rem; opacity:.85; }

    /* === Popup resultado (toast modal) === */
    .toast-backdrop {
      display:none; position:fixed; inset:0; z-index:10000;
      background: rgba(0,0,0,.45);
      align-items:center; justify-content:center; padding:16px;
    }
    .toast-backdrop.open { display:flex; }
    .toast-card {
      width: min(520px, 92vw);
      background:#fff; color:#222; border-radius:16px; padding:20px 20px 16px;
      box-shadow: 0 14px 44px rgba(0,0,0,.22);
      text-align:center; animation: toastIn .18s ease-out;
    }
    @keyframes toastIn { from { transform: translateY(8px); opacity:0 } to { transform: translateY(0); opacity:1 } }
    .toast-icon { display:none; margin: 4px auto 10px; }
    .toast-icon svg { width:86px; height:86px; display:block; margin:0 auto; }
    .toast-actions { margin-top: 10px; display:flex; justify-content:center; }

    /* Sucesso (check animado) */
    .checkmark__circle {
      stroke:#22C55E; stroke-width:3; stroke-miterlimit:10; stroke-dasharray: 166; stroke-dashoffset: 166;
      animation: stroke 0.6s cubic-bezier(.65,.0,.45,1) forwards;
    }
    .checkmark__check {
      transform-origin: 50% 50%;
      stroke:#22C55E; stroke-width:4; stroke-linecap:round; stroke-linejoin:round;
      stroke-dasharray: 48; stroke-dashoffset: 48;
      animation: stroke 0.4s 0.4s cubic-bezier(.65,.0,.45,1) forwards;
    }
    @keyframes stroke { to { stroke-dashoffset: 0; } }

    /* Erro (círculo + X animado) */
    .cross__circle {
      stroke:#EF4444; stroke-width:3; stroke-dasharray:166; stroke-dashoffset:166;
      animation: stroke 0.6s cubic-bezier(.65,.0,.45,1) forwards;
    }
    .cross__line {
      stroke:#EF4444; stroke-width:4; stroke-linecap:round;
      stroke-dasharray:28; stroke-dashoffset:28;
    }
    .cross__line--left { animation: stroke 0.35s 0.45s cubic-bezier(.65,.0,.45,1) forwards; }
    .cross__line--right { animation: stroke 0.35s 0.6s  cubic-bezier(.65,.0,.45,1) forwards; }

    /* === Modal de Confirmação (existe registro) === */
    .confirm-backdrop{
      display:none; position:fixed; inset:0; background: rgba(0,0,0,.45);
      z-index:10001; align-items:center; justify-content:center; padding:16px;
    }
    .confirm-backdrop.open{ display:flex; }
    .confirm-card{
      width:min(560px, 92vw); background:#fff; color:#222; border-radius:16px; padding:18px 20px;
      box-shadow:0 14px 44px rgba(0,0,0,.22); animation: toastIn .18s ease-out;
    }
    .confirm-title{ font-weight:800; font-size:1.1rem; margin:0 0 6px 0; display:flex; gap:8px; align-items:center;}
    .confirm-msg{ margin:0 0 10px 0; opacity:.9;}
    .confirm-list{ background:#fafafa; border:1px solid #eee; padding:10px; border-radius:10px; max-height:160px; overflow:auto; font-size:.95rem;}
    .confirm-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px;}
  </style>
</head>
<body>
<div class="main-content">
  <header>
    <div class="header-content">
      <a href="/"><img src="{% static 'extrato_app/GRUPOGC_RGB_LOGOTIPO_OFFWHITE.png' %}" alt="IMAGEM LOGO" style="max-height:75px;"></a>
      <div class="header-divider"></div>
    </div>
  </header>

  <div class="container">
    <nav class="top-tabs">
      <a href="/atualizar-relatorios" class="tab-btn {% if request.path == '/atualizar-relatorios' %}active{% endif %}"><i class="bi bi-arrow-clockwise"></i> Atualizar Relatórios</a>
      <a href="/" class="tab-btn {% if request.path == '/' %}active{% endif %}"><i class="bi bi-database-fill"></i> Consolidação Conta Virtual</a>
      <a href="/atualizar-caixa" class="tab-btn {% if request.path == '/atualizar-caixa' %}active{% endif %}"><i class="bi bi-cash-stack"></i> Atualizar Caixa</a>
    </nav>

    <div class="form-card">
      <h2><i class="bi bi-cash-stack"></i> Atualizar Caixa</h2>

      <!-- A action original pode ser qualquer; o envio será feito via fetch para 'buscar_cias_api' -->
      <form method="POST" action="{% url 'executar_atualizar_caixa' %}" id="formAtualizarCaixa">
        {% csrf_token %}

        <div class="form-group">
          <div class="selection-header">
            <label class="form-label">
              <i class="bi bi-building-fill"></i>
              Selecione as Seguradoras:
            </label>
            <div class="selection-actions">
              <span class="selected-count" id="selected-count">0</span>
              <button type="button" class="selection-action-btn" id="select-all">
                <i class="bi bi-check2-square"></i> Todos
              </button>
              <button type="button" class="selection-action-btn" id="deselect-all">
                <i class="bi bi-x-square"></i> Limpar
              </button>
            </div>
          </div>

          <div class="cias-container">
            <div class="cias-grid" id="cias-list">
              {% for cia in cias_opt %}
              <div class="cia-item" data-cia="{{ cia }}">
                <div class="cia-checkbox"></div>
                <span class="cia-name">{{ cia }}</span>
              </div>
              {% endfor %}
            </div>
          </div>

          <input type="hidden" name="cias_selected" id="cias-selected" />
        </div>

        <div class="form-group">
          <button type="button" class="btn-primary" id="btnProsseguir">
            <i class="bi bi-arrow-right-circle"></i> Prosseguir
          </button>
        </div>
      </form>
    </div>
  </div>

  <footer>
    <div class="container"><p>© 2025 Grupo GC - Todos os direitos reservados</p></div>
  </footer>
</div>

<!-- ========= MODAL ========= -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitulo">
    <div class="modal-header">
      <div class="modal-title" id="modalTitulo">
        <i class="bi bi-pencil-square"></i> Informe os valores para as CIAs selecionadas
      </div>
      <button class="close-btn" id="modalClose" type="button" aria-label="Fechar">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">
          <i class="bi bi-calendar-month"></i>
          Digite a Competência:
        </label>
        <input
          type="text"
          class="form-select"
          name="mes"
          id="inputCompetencia"
          form="formAtualizarCaixa"
          required
          placeholder="MM-AAAA"
          inputmode="numeric"
          maxlength="7"
          pattern="^(0[1-9]|1[0-2])-[0-9]{4}$"
          title="Digite no formato MM-AAAA (ex.: 01-2025)"
        />
        <div class="info-badge">
          <i class="bi bi-lightbulb"></i> Exemplo: 05-2024 para maio de 2024
        </div>
      </div>

      <div class="modal-section-title">
        <i class="bi bi-bank"></i> Valores por Seguradora
      </div>
      <div id="modalCamposCias"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" id="modalCancelar" type="button">Cancelar</button>
      <button class="btn-primary" id="modalAtualizar" type="button">
        <i class="bi bi-upload"></i> Atualizar Caixa
      </button>
    </div>
  </div>
</div>
<!-- ========= /MODAL ========= -->

<!-- ========= POPUP RESULTADO ========= -->
<div id="resultToast" class="toast-backdrop" aria-hidden="true">
  <div class="toast-card">
    <div class="toast-icon success" id="toastIconSuccess" aria-hidden="true">
      <svg class="checkmark" viewBox="0 0 52 52">
        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
        <path class="checkmark__check" fill="none" d="M14 27l7 7 16-16"/>
      </svg>
    </div>
    <div class="toast-icon error" id="toastIconError" aria-hidden="true">
      <svg class="cross" viewBox="0 0 52 52">
        <circle class="cross__circle" cx="26" cy="26" r="25" fill="none"/>
        <path class="cross__line cross__line--left" fill="none" d="M16 16 36 36"/>
        <path class="cross__line cross__line--right" fill="none" d="M36 16 16 36"/>
      </svg>
    </div>
    <h3 id="toastTitle">Sucesso!</h3>
    <p id="toastMsg"></p>
    <div class="toast-actions">
      <button class="btn-primary" id="toastClose" type="button">OK</button>
    </div>
  </div>
</div>
<!-- ========= /POPUP RESULTADO ========= -->

<!-- ========= CONFIRM EXISTE ========= -->
<div id="confirmBackdrop" class="confirm-backdrop" aria-hidden="true">
  <div class="confirm-card" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="confirm-title" id="confirmTitle">
      <i class="bi bi-exclamation-triangle-fill" style="color:#f59e0b;"></i>
      Já existe valor lançado para as seguintes CIAs
    </div>
    <p class="confirm-msg">Deseja <strong>atualizar</strong> esses registros para a competência informada?</p>
    <div id="confirmList" class="confirm-list"></div>
    <div class="confirm-actions">
      <button class="btn-secondary" id="confirmNo" type="button">Cancelar</button>
      <button class="btn-primary" id="confirmYes" type="button"><i class="bi bi-check2-circle"></i> Atualizar mesmo</button>
    </div>
  </div>
</div>
<!-- ========= /CONFIRM EXISTE ========= -->

<script>
(function() {
  const list = document.getElementById('cias-list');
  const selectedCount = document.getElementById('selected-count');
  const hiddenSelected = document.getElementById('cias-selected');
  const btnSelectAll = document.getElementById('select-all');
  const btnDeselectAll = document.getElementById('deselect-all');
  const btnProsseguir = document.getElementById('btnProsseguir');

  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalClose = document.getElementById('modalClose');
  const modalCancelar = document.getElementById('modalCancelar');
  const modalAtualizar = document.getElementById('modalAtualizar');
  const modalCamposCias = document.getElementById('modalCamposCias');
  const inputCompetencia = document.getElementById('inputCompetencia');

  // Popup resultado
  const toastEl = document.getElementById('resultToast');
  const toastTitle = document.getElementById('toastTitle');
  const toastMsg = document.getElementById('toastMsg');
  const toastIconSuccess = document.getElementById('toastIconSuccess');
  const toastIconError = document.getElementById('toastIconError');
  const toastClose = document.getElementById('toastClose');

  // Confirm existe
  const confirmEl = document.getElementById('confirmBackdrop');
  const confirmList = document.getElementById('confirmList');
  const confirmYes = document.getElementById('confirmYes');
  const confirmNo = document.getElementById('confirmNo');

  const form = document.getElementById('formAtualizarCaixa');

  (function attachMaskMMYYYY() {
    const el = document.getElementById('inputCompetencia');
    if (!el) return;

    function formatValueKeepCaret(e) {
      const input = e.target;
      const digitsBefore = input.value.slice(0, input.selectionStart).replace(/\D/g, '').length;

      let digits = input.value.replace(/\D/g, '').slice(0, 6); // MM + AAAA
      const newVal = digits.length <= 2 ? digits : digits.slice(0, 2) + '-' + digits.slice(2);
      input.value = newVal;

      const newPos = digitsBefore <= 2 ? digitsBefore : digitsBefore + 1; // +1 pelo '-'
      input.setSelectionRange(newPos, newPos);
    }

    el.addEventListener('input', formatValueKeepCaret);
    el.addEventListener('paste', (e) => {
      e.preventDefault();
      const txt = (e.clipboardData || window.clipboardData).getData('text');
      const digits = txt.replace(/\D/g, '').slice(0, 6);
      el.value = digits.length <= 2 ? digits : digits.slice(0, 2) + '-' + digits.slice(2);
      el.setSelectionRange(el.value.length, el.value.length);
    });
  })();

  function toggleItem(el) { el.classList.toggle('selected'); updateSelected(); }
  function updateSelected() {
    const active = [...list.querySelectorAll('.cia-item.selected')].map(n => n.dataset.cia);
    selectedCount.textContent = active.length;
    hiddenSelected.value = JSON.stringify(active);
  }
  btnSelectAll.addEventListener('click', () => {
    list.querySelectorAll('.cia-item').forEach(el => el.classList.add('selected'));
    updateSelected();
  });
  btnDeselectAll.addEventListener('click', () => {
    list.querySelectorAll('.cia-item').forEach(el => el.classList.remove('selected'));
    updateSelected();
  });
  list.addEventListener('click', (e) => {
    const item = e.target.closest('.cia-item');
    if (item) toggleItem(item);
  });

  btnProsseguir.addEventListener('click', () => {
    const selected = JSON.parse(hiddenSelected.value || '[]');
    if (selected.length === 0) { alert('Selecione ao menos uma seguradora (CIA).'); return; }

    modalCamposCias.innerHTML = '';
    selected.forEach(cia => {
      const row = document.createElement('div');
      row.className = 'field-row';
      row.innerHTML = `
        <div><strong>${cia}</strong></div>
        <div>
          <label style="display:block;font-size:.85rem;margin-bottom:4px;">Valor Bruto</label>
          <input type="text" class="input-text moeda" name="valor_bruto_${cia}" form="formAtualizarCaixa" placeholder="0,00" required />
        </div>
        <div>
          <label style="display:block;font-size:.85rem;margin-bottom:4px;">Valor Líquido</label>
          <input type="text" class="input-text moeda" name="valor_liquido_${cia}" form="formAtualizarCaixa" placeholder="0,00" required />
        </div>
      `;
      modalCamposCias.appendChild(row);
    });

    modalCamposCias.querySelectorAll('input.moeda').forEach(input => {
      input.addEventListener('input', (e) => {
        let txt = e.target.value.replace(/[^\d,.-]/g, '').replace(/\./g, '').replace(',', '.');
        const num = parseFloat(txt);
        if (isNaN(num)) { e.target.value = ''; return; }
        e.target.value = num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      });
      input.addEventListener('paste', (e) => {
        const focused = e.target;
        const inputs = [...modalCamposCias.querySelectorAll('input.moeda')];
        const startIndex = inputs.indexOf(focused);
        const text = e.clipboardData.getData('text/plain');
        const rows = text.split(/\r?\n/).filter(r => r.trim() !== '');
        if (rows.length <= 1 && !rows[0].includes('\t')) return;
        e.preventDefault();
        const flat = [];
        for (const r of rows) { flat.push(...r.split('\t')); }
        for (let i = 0; i < flat.length && (startIndex + i) < inputs.length; i++) {
          const raw = flat[i].replace(/R\$/g, '').replace(/\./g, '').replace(',', '.').trim();
          const v = parseFloat(raw);
          if (!isNaN(v)) {
            inputs[startIndex + i].value = v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          }
        }
      });
    });

    openModal();
  });

  function openModal(){ modalBackdrop.classList.add('open'); modalBackdrop.setAttribute('aria-hidden','false'); inputCompetencia.focus(); }
  function closeModal(){ modalBackdrop.classList.remove('open'); modalBackdrop.setAttribute('aria-hidden','true'); }
  modalClose.addEventListener('click', closeModal);
  modalCancelar.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });

  function showToast(type, message) {
    toastIconSuccess.style.display = type === 'success' ? 'block' : 'none';
    toastIconError.style.display   = type === 'error'   ? 'block' : 'none';
    toastTitle.textContent = type === 'success' ? 'Sucesso!' : 'Ops...';
    toastMsg.textContent = message || '';
    toastEl.classList.add('open'); toastEl.setAttribute('aria-hidden','false');
  }
  function hideToast(){ toastEl.classList.remove('open'); toastEl.setAttribute('aria-hidden','true'); }
  toastClose.addEventListener('click', hideToast);
  toastEl.addEventListener('click', (e)=>{ if(e.target===toastEl) hideToast(); });

  function openConfirm(ciasExistentes = [], ciasInseridas = []) {
    let html = '';
    if (ciasInseridas.length) {
      html += `<div style="margin-bottom:8px;"><strong>Inseridas agora:</strong></div>`;
      html += `<div style="margin-left:8px; margin-bottom:10px;">${ciasInseridas.map(c=>`• ${c}`).join('<br>')}</div>`;
    }
    if (ciasExistentes.length) {
      html += `<div style="margin-bottom:8px;"><strong>Já existiam (aguardam sua confirmação para atualizar):</strong></div>`;
      html += `<div style="margin-left:8px;">${ciasExistentes.map(c=>`• ${c}`).join('<br>')}</div>`;
    }
    confirmList.innerHTML = html || '—';
    confirmEl.classList.add('open'); confirmEl.setAttribute('aria-hidden','false');
  }
  function closeConfirm(){
    confirmEl.classList.remove('open'); confirmEl.setAttribute('aria-hidden','true');
  }
  confirmNo.addEventListener('click', closeConfirm);
  confirmEl.addEventListener('click', (e)=>{ if(e.target===confirmEl) closeConfirm(); });

  const ENDPOINT_BUSCAR_CIAS = "{% url 'buscar_cias_api' %}";

  async function postCaixa(forcarUpdate=false){
    const selected = JSON.parse(hiddenSelected.value || '[]');
    const fd = new FormData(form);
    fd.set('cias', JSON.stringify(selected));     
    if (forcarUpdate) fd.set('forcar_update', 'true');

    const csrftoken = document.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';

    const originalText = modalAtualizar.innerHTML;
    modalAtualizar.disabled = true;
    modalAtualizar.innerHTML = '<i class="bi bi-arrow-repeat"></i> Processando...';

    try{
      const resp = await fetch(ENDPOINT_BUSCAR_CIAS, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrftoken
        },
        body: fd
      });
      const data = await resp.json().catch(()=>null);

      closeModal();

      if (resp.ok && data){
        if (data.status === 'ok'){
          showToast('success', data.message || 'Processo concluído.');
        } else if (data.status === 'existe'){
          openConfirm(data.cias_existentes || [], data.cias_inseridas || []);
        } else {
          showToast('error', data.message || 'Falha ao processar.');
        }
      } else {
        showToast('error', 'Erro no servidor.');
      }
    }catch(err){
      showToast('error', err?.message || 'Erro inesperado.');
    }finally{
      modalAtualizar.disabled = false;
      modalAtualizar.innerHTML = originalText;
    }
  }

  modalAtualizar.addEventListener('click', async () => {
    if (!form.reportValidity()) return;
    await postCaixa(false);
  });

  confirmYes.addEventListener('click', async () => {
    closeConfirm();
    await postCaixa(true);
  });

})();
</script>


</body>
</html>
